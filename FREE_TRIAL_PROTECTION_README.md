# ๐ก๏ธ ูุธุงู ุญูุงูุฉ ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ ูู ุฅุนุงุฏุฉ ุงูุงุณุชุฎุฏุงู

## ๐จ ุงููุดููุฉ ุงูุฃุตููุฉ
ุจุนุฏ ุญุฐู ุงููุณุชุฎุฏู ูู ุงูุชุทุจููุ ููููู ุฅุนุงุฏุฉ ุงูุชุณุฌูู ุจููุณ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุงูุญุตูู ุนูู ููููู ูุฌุงูููู ุฌุฏูุฏููุ ููุง ูุคุฏู ุฅูู:
- โ **ุฅุณุงุกุฉ ุงุณุชุฎุฏุงู** ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ
- โ **ุฎุณุงุฑุฉ ุฅูุฑุงุฏุงุช** ูู ุงููุณุชุฎุฏููู ุงููุชูุฑุฑูู
- โ **ุนุฏู ุนุฏุงูุฉ** ุชุฌุงู ุงููุณุชุฎุฏููู ุงูุฌุฏุฏ

## โ ุงูุญู ุงูุดุงูู ุงููุทุจู

### 1. ุฅุตูุงุญ ูุดููุฉ ุงูุชุณุฌูู
- โ ุฅุถุงูุฉ ุณูุงุณุฉ INSERT ููููุฏุฉ ูุฌุฏูู `profiles`
- โ ุฅุตูุงุญ ุฎุทุฃ "Database error saving new user"

### 2. ูุธุงู ุญูุงูุฉ ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ
- โ **ุฌุฏูู ุชุชุจุน**: `free_trial_usage` ูุชุชุจุน ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงููุณุชุฎุฏู
- โ **ุฏูุงู ุญูุงูุฉ**: ููุชุญูู ูู ุงูุงุณุชุฎุฏุงู ุงูุณุงุจู
- โ **ูุดุบูุงุช ุชููุงุฆูุฉ**: ูุชุณุฌูู ุงูุงุณุชุฎุฏุงู ุนูุฏ ุงูุชูุนูู
- โ **ููุน ุฅุนุงุฏุฉ ุงูุงุณุชุฎุฏุงู**: ููุจุฑูุฏ ุงูุฅููุชุฑููู ุงููุณุชุฎุฏู ูุณุจูุงู

## ๐๏ธ ูููู ูุงุนุฏุฉ ุงูุจูุงูุงุช

### ุฌุฏูู `free_trial_usage`
```sql
CREATE TABLE free_trial_usage (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  email text NOT NULL UNIQUE,           -- ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (ูุฑูุฏ)
  first_used_at timestamptz DEFAULT now(), -- ุฃูู ุงุณุชุฎุฏุงู
  last_used_at timestamptz DEFAULT now(),  -- ุขุฎุฑ ุงุณุชุฎุฏุงู
  usage_count integer DEFAULT 1,        -- ุนุฏุฏ ูุฑุงุช ุงูุงุณุชุฎุฏุงู
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

### ุงูุฏูุงู ุงูุฑุฆูุณูุฉ

#### 1. `has_used_free_trial_before(email)`
```sql
-- ุชุญูู ุฅุฐุง ูุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงุณุชุฎุฏู ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ ูุณุจูุงู
SELECT has_used_free_trial_before('user@example.com');
-- Returns: TRUE/FALSE
```

#### 2. `should_grant_free_trial(email)`
```sql
-- ุชุญูู ุฅุฐุง ูุงู ูุฌุจ ููุญ ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ
SELECT should_grant_free_trial('user@example.com');
-- Returns: TRUE (ุฌุฏูุฏ) / FALSE (ูุณุชุฎุฏู ูุณุจูุงู)
```

#### 3. `record_free_trial_usage(email)`
```sql
-- ุชุณุฌูู ุงุณุชุฎุฏุงู ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ
SELECT record_free_trial_usage('user@example.com');
-- Records usage automatically
```

#### 4. `check_free_trial_status_with_protection(user_id)`
```sql
-- ูุญุต ุญุงูุฉ ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ ูุน ุงูุญูุงูุฉ
SELECT * FROM check_free_trial_status_with_protection('user-uuid');
-- Returns: has_free_trial, free_trial_expired, trial_end_date, email_used_before
```

## ๐ ุขููุฉ ุงูุนูู

### ุนูุฏ ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ:
1. โ **ุฅูุดุงุก ุงูุญุณุงุจ** ูู `auth.users`
2. โ **ุฅูุดุงุก Profile** ูู `profiles` (ูุตูุญ ุงูุขู)
3. โ **ูุญุต ุงูุจุฑูุฏ ุงูุฅููุชุฑููู** ูู `free_trial_usage`
4. โ **ููุญ ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ** ููุท ุฅุฐุง ูู ูุณุชุฎุฏู ูุณุจูุงู

### ุนูุฏ ุชูุนูู ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ:
1. โ **ุชุณุฌูู ุงูุงุณุชุฎุฏุงู** ุชููุงุฆูุงู ูู `free_trial_usage`
2. โ **ุชุญุฏูุซ ุนุฏุงุฏ ุงูุงุณุชุฎุฏุงู** (`usage_count`)
3. โ **ุชุญุฏูุซ ุชุงุฑูุฎ ุขุฎุฑ ุงุณุชุฎุฏุงู** (`last_used_at`)

### ุนูุฏ ุฅุนุงุฏุฉ ุงูุชุณุฌูู:
1. โ **ูุญุต ุงูุจุฑูุฏ ุงูุฅููุชุฑููู** ูู `free_trial_usage`
2. โ **ุฑูุถ ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ** ุฅุฐุง ุงุณุชุฎุฏู ูุณุจูุงู
3. โ **ุฅุธูุงุฑ ุฑุณุงูุฉ ูุงุถุญุฉ** ูููุณุชุฎุฏู

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

### 1. ุชูููุฐ ุงูุฅุตูุงุญ ุงูุดุงูู
```bash
# ูู Supabase Dashboard > SQL Editor
# ุงูุณุฎ ูุญุชูู ููู: quick_fix_profiles_insert_with_trial_protection.sql
# ุงุถุบุท Run
```

### 2. ุงูุชุญูู ูู ุงูุชุทุจูู
```sql
-- ูุญุต ุงูุณูุงุณุงุช
SELECT policyname, cmd FROM pg_policies WHERE tablename = 'profiles';

-- ูุญุต ุฌุฏูู ุงูุญูุงูุฉ
SELECT COUNT(*) FROM free_trial_usage;

-- ุงุฎุชุจุงุฑ ุงููุธุงู
SELECT should_grant_free_trial('test@example.com');
```

## ๐ ุงุฎุชุจุงุฑ ุงููุธุงู

### ุงุฎุชุจุงุฑ ุงููุณุชุฎุฏู ุงูุฌุฏูุฏ:
```sql
-- 1. ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ
-- 2. ุชูุนูู ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ
-- 3. ุงูุชุญูู ูู ุงูุชุณุฌูู
SELECT * FROM free_trial_usage WHERE email = 'newuser@example.com';
-- Expected: 1 record with usage_count = 1
```

### ุงุฎุชุจุงุฑ ุฅุนุงุฏุฉ ุงูุชุณุฌูู:
```sql
-- 1. ุญุฐู ุงูุญุณุงุจ
-- 2. ุฅุนุงุฏุฉ ุงูุชุณุฌูู ุจููุณ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
-- 3. ูุญุงููุฉ ุชูุนูู ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ
SELECT should_grant_free_trial('newuser@example.com');
-- Expected: FALSE (no free trial)
```

## ๐ฏ ุงููุชุงุฆุฌ ุงููุชููุนุฉ

### โ ุจุนุฏ ุชุทุจูู ุงูุฅุตูุงุญ:
- **ุชุณุฌูู ุงููุณุชุฎุฏููู** ูุนูู ุจุฏูู ุฃุฎุทุงุก
- **ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ** ุชุนูู ูููุณุชุฎุฏููู ุงูุฌุฏุฏ ููุท
- **ููุน ุฅุนุงุฏุฉ ุงูุงุณุชุฎุฏุงู** ููุจุฑูุฏ ุงูุฅููุชุฑููู ุงููุณุชุฎุฏู ูุณุจูุงู
- **ุชุชุจุน ุฏููู** ูุฌููุน ุงุณุชุฎุฏุงูุงุช ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ

### ๐ ุฅุญุตุงุฆูุงุช ูููู ูุฑุงูุจุชูุง:
```sql
-- ุฅุฌูุงูู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงููุญูู
SELECT COUNT(*) FROM free_trial_usage;

-- ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงูุฃูุซุฑ ุงุณุชุฎุฏุงูุงู
SELECT email, usage_count, last_used_at 
FROM free_trial_usage 
ORDER BY usage_count DESC;

-- ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงูุฌุฏูุฏ ูุฐุง ุงูุดูุฑ
SELECT COUNT(*) 
FROM free_trial_usage 
WHERE created_at >= date_trunc('month', now());
```

## ๐ง ุงูุชุญุฏูุซุงุช ุงููุทููุจุฉ ูู ุงูููุฏ

### ูู `contexts/SubscriptionContext.tsx`:
```typescript
const checkFreeTrialStatus = async () => {
  if (!user) return;

  try {
    // ุงุณุชุฎุฏุงู ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ ูุน ุงูุญูุงูุฉ
    const { data, error } = await supabase.rpc(
      'check_free_trial_status_with_protection',
      { user_uuid: user.id }
    );

    if (error) {
      console.error('Error checking trial status:', error);
      return;
    }

    if (data && data.length > 0) {
      const result = data[0];
      
      if (mountedRef.current) {
        setHasFreeTrial(result.has_free_trial);
        setFreeTrialExpired(result.free_trial_expired);
        
        // ุฅุฐุง ูุงู ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุณุชุฎุฏู ูุณุจูุงู
        if (result.email_used_before) {
          console.log('Email has used free trial before - no free trial granted');
        }
      }
    }
  } catch (error) {
    console.error('Error checking trial status:', error);
  }
};
```

### ูู `app/subscription.tsx`:
```typescript
const handleActivateFreeTrial = async () => {
  if (!user) return;
  
  try {
    // ุงูุชุญูู ูู ุฅููุงููุฉ ููุญ ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ
    const { data: canGrant, error: checkError } = await supabase.rpc(
      'should_grant_free_trial',
      { user_email: user.email }
    );

    if (checkError) throw checkError;

    if (!canGrant) {
      showAlert('Free Trial Used', 'This email has already used the free trial. Please upgrade to continue.');
      return;
    }

    // ุชูุนูู ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ (ุณูุชู ุชุณุฌูู ุงูุงุณุชุฎุฏุงู ุชููุงุฆูุงู)
    // ... ุจุงูู ุงูููุฏ
  } catch (error) {
    console.error('Free trial activation failed:', error);
  }
};
```

## ๐ก๏ธ ููุฒุงุช ุงูุฃูุงู

### 1. **ุญูุงูุฉ ุงูุจูุงูุงุช**:
- ุฌุฏูู `free_trial_usage` ูุญูู ุจู RLS
- ููุท Superadmin ููููู ุฅุฏุงุฑุฉ ุงูุจูุงูุงุช
- ุงูุจูุงูุงุช ูุดูุฑุฉ ููุคููุฉ

### 2. **ููุน ุงูุชูุงุนุจ**:
- ูุญุต ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุฑูุฏ
- ุชุณุฌูู ุชููุงุฆู ุนูุฏ ุงูุชูุนูู
- ูุง ูููู ุญุฐู ุณุฌู ุงูุงุณุชุฎุฏุงู

### 3. **ุงูุดูุงููุฉ**:
- ุงููุณุชุฎุฏู ูุนุฑู ุณุจุจ ุนุฏู ููุญ ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ
- ุฑุณุงุฆู ูุงุถุญุฉ ููููููุฉ
- ุฅููุงููุฉ ูุฑุงุฌุนุฉ ุงูุจูุงูุงุช ููุฃุฏูู

## ๐ ููุงุญุธุงุช ูููุฉ

1. **ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ**: ุงููุธุงู ูุง ูุคุซุฑ ุนูู ุงููุณุชุฎุฏููู ุงูุญุงูููู
2. **ุงูุชุญุฏูุซ ุงูุชููุงุฆู**: ุงููุดุบูุงุช ุชุนูู ุชููุงุฆูุงู
3. **ุงูุฃุฏุงุก**: ุงููุญุต ุณุฑูุน ููุง ูุคุซุฑ ุนูู ุงูุฃุฏุงุก
4. **ุงููุฑููุฉ**: ูููู ุชุนุฏูู ุงูููุงุนุฏ ุญุณุจ ุงูุญุงุฌุฉ

## ๐ ุงูุฎูุงุตุฉ

ุชู ุชุทุจูู ูุธุงู ุดุงูู ูุญู ูุดููุชูู:
- โ **ุฅุตูุงุญ ุฎุทุฃ ุงูุชุณุฌูู** (ุณูุงุณุฉ INSERT ููููุฏุฉ)
- โ **ุญูุงูุฉ ุงูุชุฌุฑุจุฉ ุงููุฌุงููุฉ** ูู ุฅุนุงุฏุฉ ุงูุงุณุชุฎุฏุงู

**ุงููุธุงู ุขูู ููุนุงู ููุญูู ุฅูุฑุงุฏุงุช ุงูุชุทุจูู ูู ุฅุณุงุกุฉ ุงูุงุณุชุฎุฏุงู.** 