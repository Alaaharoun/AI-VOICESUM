# ๐ง ุฅุตูุงุญ ูุดููุฉ ุชุณุฌูู ุงููุณุชุฎุฏููู ุงูุฌุฏุฏ

## ๐จ ุงููุดููุฉ
ุจุนุฏ ุญุฐู ุงููุณุชุฎุฏู ูู ุงูุชุทุจููุ ูุง ูููู ุฅุนุงุฏุฉ ุงูุชุณุฌูู ุจููุณ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ุฃู ุจุฑูุฏ ุฅููุชุฑููู ุฌุฏูุฏุ ููุธูุฑ ุฎุทุฃ:
```
"Database error saving new user"
```

## ๐ ุณุจุจ ุงููุดููุฉ
ุงููุดููุฉ ูู **ุณูุงุณุฉ INSERT** ูุฌุฏูู `profiles` ูู Supabase. ุนูุฏ ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ:

1. ูุชู ุฅูุดุงุก ุงูุญุณุงุจ ูู `auth.users`
2. ูุญุงูู ุงูููุฏ ุฅูุดุงุก profile ูู ุฌุฏูู `profiles`
3. **ูุง ุชูุฌุฏ ุณูุงุณุฉ INSERT** ุชุณูุญ ูููุณุชุฎุฏููู ุจุฅูุดุงุก profile ูุฃููุณูู
4. ููุดู ุงูุชุณุฌูู ูุน ุฑุณุงูุฉ ุฎุทุฃ ุนุงูุฉ

## โ ุงูุญู ุงููุทุจู

### 1. ุฅูุดุงุก Migration ุฌุฏูุฏ
ุชู ุฅูุดุงุก ููู `supabase/migrations/20250705220000_fix_profiles_insert_policy.sql` ูุญุชูู ุนูู:

```sql
-- ุงูุณูุงุณุฉ ุงูููููุฏุฉ ุงูุชู ูุงูุช ุชุณุจุจ ุงูุฎุทุฃ
CREATE POLICY "Users can insert their own profile"
  ON profiles FOR INSERT
  TO authenticated
  WITH CHECK (user_id = auth.uid());
```

### 2. ุงูุณูุงุณุงุช ุงููุทููุจุฉ ูุฌุฏูู profiles
- โ **SELECT**: ุนุฑุถ profile ุงููุณุชุฎุฏู
- โ **UPDATE**: ุชุญุฏูุซ profile ุงููุณุชุฎุฏู  
- โ **INSERT**: ุฅูุดุงุก profile ุฌุฏูุฏ (ูุงูุช ููููุฏุฉ)

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

### 1. ุชุทุจูู Migration
```bash
# ูู Supabase Dashboard
# ุงุฐูุจ ุฅูู SQL Editor
# ููุฐ ุงูููู: 20250705220000_fix_profiles_insert_policy.sql
```

### 2. ุงุฎุชุจุงุฑ ุงูุชุณุฌูู
```bash
# ุฌุฑุจ ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ
# ูุฌุจ ุฃู ูุนูู ุจุฏูู ุฃุฎุทุงุก
```

## ๐ ุงูุชุญูู ูู ุงูุฅุตูุงุญ

### 1. ูุญุต ุงูุณูุงุณุงุช
```sql
-- ุชุญูู ูู ูุฌูุฏ ุฌููุน ุงูุณูุงุณุงุช ุงููุทููุจุฉ
SELECT schemaname, tablename, policyname, permissive, roles, cmd, qual, with_check
FROM pg_policies 
WHERE tablename = 'profiles';
```

### 2. ุงุฎุชุจุงุฑ ุงูุชุณุฌูู
- โ ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ
- โ ุฅูุดุงุก profile ุชููุงุฆูุงู
- โ ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ

## ๐ง ุงูููุฏ ุงููุชุฃุซุฑ

### ูู `contexts/AuthContext.tsx`:
```typescript
const signUp = async (email: string, password: string) => {
  // ... ุฅูุดุงุก ุงูุญุณุงุจ
  if (!result.error && result.data?.user) {
    const user = result.data.user;
    try {
      // ูุฐุง ุงูุณุทุฑ ูุงู ููุดู ุจุณุจุจ ุนุฏู ูุฌูุฏ ุณูุงุณุฉ INSERT
      const { error: profileError } = await supabase.from('profiles').insert([
        {
          id: user.id,
          full_name: '',
          avatar_url: ''
        }
      ]);
      // ุงูุขู ุณูุนูู ุจูุฌุงุญ
    } catch (profileInsertError) {
      console.error('[AuthContext] Exception creating profile after sign up:', profileInsertError);
    }
  }
};
```

## ๐ฏ ุงููุชูุฌุฉ ุงููุชููุนุฉ

ุจุนุฏ ุชุทุจูู ุงูุฅุตูุงุญ:
- โ **ุชุณุฌูู ูุณุชุฎุฏููู ุฌุฏุฏ** ูุนูู ุจุฏูู ุฃุฎุทุงุก
- โ **ุฅุนุงุฏุฉ ุงูุชุณุฌูู** ุจุนุฏ ุญุฐู ุงูุญุณุงุจ ูุนูู
- โ **ุฅูุดุงุก profile** ุชููุงุฆูุงู ููู ูุณุชุฎุฏู ุฌุฏูุฏ
- โ **ุชุณุฌูู ุงูุฏุฎูู** ูุนูู ุจุดูู ุทุจูุนู

## ๐ ููุงุญุธุงุช ูููุฉ

1. **RLS (Row Level Security)** ููุนู ุนูู ุฌุฏูู `profiles`
2. **ุงูุณูุงุณุงุช ูุทููุจุฉ** ูุฌููุน ุงูุนูููุงุช (SELECT, INSERT, UPDATE)
3. **ุงููุณุชุฎุฏููู ุงูุฌุฏุฏ** ูุญุชุงุฌูู ุตูุงุญูุฉ ุฅูุดุงุก profile ูุฃููุณูู
4. **Superadmin** ูุฏูู ุตูุงุญูุงุช ูุงููุฉ ุนูู ุฌููุน profiles

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ:
1. ุชุญูู ูู ุชุทุจูู Migration ุจูุฌุงุญ
2. ุชุญูู ูู ูุฌูุฏ ุงูุณูุงุณุงุช ูู Supabase Dashboard
3. ุฑุงุฌุน ุณุฌูุงุช ุงูุฃุฎุทุงุก ูู Supabase
4. ุชุฃูุฏ ูู ุฃู RLS ููุนู ุนูู ุฌุฏูู `profiles` 