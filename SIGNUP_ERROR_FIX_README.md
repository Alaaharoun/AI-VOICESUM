# ๐จ ุฅุตูุงุญ ูุดููุฉ ุชุณุฌูู ุงููุณุชุฎุฏููู ุงูุฌุฏุฏ

## ุงููุดููุฉ
ุจุนุฏ ุญุฐู ุงููุณุชุฎุฏู ูู ุงูุชุทุจููุ ูุง ูููู ุฅุนุงุฏุฉ ุงูุชุณุฌูู ุจููุณ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุฃู ุฃู ุจุฑูุฏ ุฅููุชุฑููู ุฌุฏูุฏุ ููุธูุฑ ุฎุทุฃ:
```
"Database error saving new user"
```

## ๐ ุชุญููู ุงููุดููุฉ

### ุงูุณุจุจ ุงูุฌุฐุฑู
ุงููุดููุฉ ูู **ุณูุงุณุฉ INSERT** ูุฌุฏูู `profiles` ูู Supabase. ุนูุฏ ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ:

1. โ ูุชู ุฅูุดุงุก ุงูุญุณุงุจ ูู `auth.users` ุจูุฌุงุญ
2. โ ูุญุงูู ุงูููุฏ ุฅูุดุงุก profile ูู ุฌุฏูู `profiles`
3. โ **ูุง ุชูุฌุฏ ุณูุงุณุฉ INSERT** ุชุณูุญ ูููุณุชุฎุฏููู ุจุฅูุดุงุก profile ูุฃููุณูู
4. โ ููุดู ุงูุชุณุฌูู ูุน ุฑุณุงูุฉ ุฎุทุฃ ุนุงูุฉ

### ุงูููุฏ ุงููุชุฃุซุฑ
ูู `contexts/AuthContext.tsx`:
```typescript
const signUp = async (email: string, password: string) => {
  // ... ุฅูุดุงุก ุงูุญุณุงุจ ูู auth.users
  if (!result.error && result.data?.user) {
    const user = result.data.user;
    try {
      // ูุฐุง ุงูุณุทุฑ ูุงู ููุดู ุจุณุจุจ ุนุฏู ูุฌูุฏ ุณูุงุณุฉ INSERT
      const { error: profileError } = await supabase.from('profiles').insert([
        {
          id: user.id,
          full_name: '',
          avatar_url: ''
        }
      ]);
    } catch (profileInsertError) {
      console.error('[AuthContext] Exception creating profile after sign up:', profileInsertError);
    }
  }
};
```

## โ ุงูุญู ุงููุทุจู

### 1. ุฅูุดุงุก Migration ุฌุฏูุฏ
ุชู ุฅูุดุงุก ููู `supabase/migrations/20250705220000_fix_profiles_insert_policy.sql`

### 2. ุฅูุดุงุก ููู ุฅุตูุงุญ ุณุฑูุน
ุชู ุฅูุดุงุก ููู `quick_fix_profiles_insert.sql` ููุชูููุฐ ุงููุจุงุดุฑ

### 3. ุงูุณูุงุณุงุช ุงููุทููุจุฉ
```sql
-- ุงูุณูุงุณุฉ ุงูููููุฏุฉ ุงูุชู ูุงูุช ุชุณุจุจ ุงูุฎุทุฃ
CREATE POLICY "Users can insert their own profile"
  ON profiles FOR INSERT
  TO authenticated
  WITH CHECK (user_id = auth.uid());
```

## ๐ ุฎุทูุงุช ุงูุชุทุจูู

### ุงูุทุฑููุฉ ุงูุฃููู: ุงุณุชุฎุฏุงู ุงูููู ุงูุณุฑูุน
1. ุงุฐูุจ ุฅูู [Supabase Dashboard](https://supabase.com/dashboard)
2. ุงุฎุชุฑ ูุดุฑูุนู
3. ุงุฐูุจ ุฅูู **SQL Editor**
4. ุงูุณุฎ ูุญุชูู ููู `quick_fix_profiles_insert.sql`
5. ุงุถุบุท **Run** ูุชูููุฐ ุงูุฅุตูุงุญ

### ุงูุทุฑููุฉ ุงูุซุงููุฉ: ุงุณุชุฎุฏุงู Migration
1. ุงุฐูุจ ุฅูู **Migrations** ูู Supabase
2. ุงุฑูุน ููู `20250705220000_fix_profiles_insert_policy.sql`
3. ููุฐ Migration

## ๐ ุงูุชุญูู ูู ุงูุฅุตูุงุญ

### 1. ูุญุต ุงูุณูุงุณุงุช
```sql
-- ุชุญูู ูู ูุฌูุฏ ุฌููุน ุงูุณูุงุณุงุช ุงููุทููุจุฉ
SELECT 
  policyname, 
  cmd, 
  permissive,
  roles
FROM pg_policies 
WHERE tablename = 'profiles'
ORDER BY policyname;
```

**ุงููุชูุฌุฉ ุงููุชููุนุฉ:**
- `Users can view their own profile` (SELECT)
- `Users can update their own profile` (UPDATE)
- `Users can insert their own profile` (INSERT)
- `Superadmins can view all profiles` (SELECT)
- `Superadmins can manage all profiles` (ALL)

### 2. ุงุฎุชุจุงุฑ ุงูุชุณุฌูู
- โ ุชุณุฌูู ูุณุชุฎุฏู ุฌุฏูุฏ
- โ ุฅูุดุงุก profile ุชููุงุฆูุงู
- โ ุชุณุฌูู ุงูุฏุฎูู ุจูุฌุงุญ
- โ ุฅุนุงุฏุฉ ุงูุชุณุฌูู ุจุนุฏ ุญุฐู ุงูุญุณุงุจ

## ๐ฏ ุงููุชูุฌุฉ ุงููุชููุนุฉ

ุจุนุฏ ุชุทุจูู ุงูุฅุตูุงุญ:
- โ **ุชุณุฌูู ูุณุชุฎุฏููู ุฌุฏุฏ** ูุนูู ุจุฏูู ุฃุฎุทุงุก
- โ **ุฅุนุงุฏุฉ ุงูุชุณุฌูู** ุจุนุฏ ุญุฐู ุงูุญุณุงุจ ูุนูู
- โ **ุฅูุดุงุก profile** ุชููุงุฆูุงู ููู ูุณุชุฎุฏู ุฌุฏูุฏ
- โ **ุชุณุฌูู ุงูุฏุฎูู** ูุนูู ุจุดูู ุทุจูุนู
- โ **ุญุฐู ุงูุญุณุงุจ** ูุนูู ุจุฏูู ูุดุงูู

## ๐ ููุงุญุธุงุช ูููุฉ

### 1. RLS (Row Level Security)
- ููุนู ุนูู ุฌุฏูู `profiles`
- ูุชุทูุจ ุณูุงุณุงุช ุตุฑูุญุฉ ูุฌููุน ุงูุนูููุงุช
- ูููุน ุงููุตูู ุบูุฑ ุงููุตุฑุญ ุจู

### 2. ุงูุณูุงุณุงุช ุงููุทููุจุฉ
- **SELECT**: ุนุฑุถ profile ุงููุณุชุฎุฏู
- **UPDATE**: ุชุญุฏูุซ profile ุงููุณุชุฎุฏู
- **INSERT**: ุฅูุดุงุก profile ุฌุฏูุฏ (ูุงูุช ููููุฏุฉ)

### 3. ุตูุงุญูุงุช ุงููุณุชุฎุฏููู
- **ุงููุณุชุฎุฏููู ุงูุนุงุฏููู**: ูููููู ุฅุฏุงุฑุฉ profile ุงูุฎุงุต ุจูู ููุท
- **Superadmin**: ูุฏูู ุตูุงุญูุงุช ูุงููุฉ ุนูู ุฌููุน profiles

## ๐ ุงุณุชูุดุงู ุงูุฃุฎุทุงุก

### ุฅุฐุง ุงุณุชูุฑุช ุงููุดููุฉ:

1. **ุชุญูู ูู ุชุทุจูู ุงูุฅุตูุงุญ:**
   ```sql
   SELECT COUNT(*) FROM pg_policies WHERE tablename = 'profiles' AND cmd = 'INSERT';
   ```

2. **ุชุญูู ูู RLS:**
   ```sql
   SELECT schemaname, tablename, rowsecurity 
   FROM pg_tables 
   WHERE tablename = 'profiles';
   ```

3. **ุฑุงุฌุน ุณุฌูุงุช ุงูุฃุฎุทุงุก:**
   - ุงุฐูุจ ุฅูู Supabase Dashboard
   - ุงุฐูุจ ุฅูู **Logs**
   - ุงุจุญุซ ุนู ุฃุฎุทุงุก ูุชุนููุฉ ุจู `profiles`

4. **ุงุฎุชุจุงุฑ ูุจุงุดุฑ:**
   ```sql
   -- ุงุฎุชุจุงุฑ ุฅูุดุงุก profile (ูุฌุจ ุฃู ูุนูู)
   INSERT INTO profiles (user_id, full_name, avatar_url)
   VALUES (auth.uid(), 'Test User', '');
   ```

## ๐ ุงููููุงุช ุงููุญุฏุซุฉ

| ุงูููู | ุงููุตู |
|-------|-------|
| `supabase/migrations/20250705220000_fix_profiles_insert_policy.sql` | Migration ุฑุณูู |
| `quick_fix_profiles_insert.sql` | ุฅุตูุงุญ ุณุฑูุน ููุชูููุฐ ุงููุจุงุดุฑ |
| `PROFILES_INSERT_POLICY_FIX.md` | ุฏููู ููุตู |
| `SIGNUP_ERROR_FIX_README.md` | ูุฐุง ุงูููู |

## ๐ ุงูุฎูุงุตุฉ

ุงููุดููุฉ ูุงูุช ูู **ุณูุงุณุฉ INSERT ููููุฏุฉ** ูุฌุฏูู `profiles`. ุจุนุฏ ุชุทุจูู ุงูุฅุตูุงุญ:

- โ **ุชุณุฌูู ุงููุณุชุฎุฏููู** ูุนูู ุจุดูู ุทุจูุนู
- โ **ุฅุนุงุฏุฉ ุงูุชุณุฌูู** ุจุนุฏ ุญุฐู ุงูุญุณุงุจ ูุนูู
- โ **ุฌููุน ุงููุธุงุฆู** ุชุนูู ุจุฏูู ูุดุงูู

**ุงูุฅุตูุงุญ ุขูู ููุง ูุคุซุฑ ุนูู ุงูุจูุงูุงุช ุงูููุฌูุฏุฉ.** 