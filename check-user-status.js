// ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Supabase
const { createClient } = require('@supabase/supabase-js');
const fs = require('fs');
const path = require('path');

// Ù‚Ø±Ø§Ø¡Ø© Ù…Ù„Ù .env
function loadEnvFile() {
  try {
    const envPath = path.join(__dirname, '.env');
    if (fs.existsSync(envPath)) {
      const envContent = fs.readFileSync(envPath, 'utf8');
      const envVars = {};

      envContent.split('\n').forEach(line => {
        const trimmedLine = line.trim();
        if (trimmedLine && !trimmedLine.startsWith('#')) {
          const [key, ...valueParts] = trimmedLine.split('=');
          if (key && valueParts.length > 0) {
            envVars[key.trim()] = valueParts.join('=').trim();
          }
        }
      });

      return envVars;
    }
  } catch (error) {
    console.error('Error loading .env file:', error);
  }
  return {};
}

async function checkUserStatus() {
  console.log('ğŸ” ÙØ­Øµ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Supabase...\n');

  const envVars = loadEnvFile();
  const supabaseUrl = envVars.EXPO_PUBLIC_SUPABASE_URL || process.env.EXPO_PUBLIC_SUPABASE_URL;
  const supabaseAnonKey = envVars.EXPO_PUBLIC_SUPABASE_ANON_KEY || process.env.EXPO_PUBLIC_SUPABASE_ANON_KEY;

  if (!supabaseUrl || !supabaseAnonKey) {
    console.error('âŒ Ù…ØªØºÙŠØ±Ø§Øª Supabase Ù…ÙÙ‚ÙˆØ¯Ø©');
    return;
  }

  const supabase = createClient(supabaseUrl, supabaseAnonKey, {
    auth: {
      autoRefreshToken: true,
      persistSession: true,
      detectSessionInUrl: false
    },
    global: {
      headers: {
        'Cache-Control': 'no-cache',
        'Pragma': 'no-cache',
        'Expires': '0',
        'Accept': 'application/json',
        'Content-Type': 'application/json',
        'Prefer': 'return=representation'
      }
    }
  });

  try {
    // ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    console.log('1ï¸âƒ£ ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©...');
    const { data: { session }, error: sessionError } = await supabase.auth.getSession();
    
    if (sessionError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ø¬Ù„Ø³Ø©:', sessionError.message);
    } else if (session) {
      console.log('âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„');
      console.log(`   - User ID: ${session.user.id}`);
      console.log(`   - Email: ${session.user.email}`);
      console.log(`   - Created: ${session.user.created_at}`);
    } else {
      console.log('âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø¯Ø®ÙˆÙ„');
    }

    // ÙØ­Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    console.log('\n2ï¸âƒ£ ÙØ­Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...');
    const { data: users, error: usersError } = await supabase
      .from('profiles')
      .select('id, email, full_name, created_at')
      .limit(5);

    if (usersError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:', usersError.message);
    } else {
      console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${users.length} Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†`);
      users.forEach((user, index) => {
        console.log(`   ${index + 1}. ${user.email} (${user.full_name || 'No name'})`);
      });
    }

    // ÙØ­Øµ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†
    console.log('\n3ï¸âƒ£ ÙØ­Øµ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†...');
    const { data: subscriptions, error: subsError } = await supabase
      .from('user_subscriptions')
      .select('id, user_id, subscription_type, active, expires_at')
      .limit(5);

    if (subsError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø§Ù„Ù…Ø´ØªØ±ÙƒÙŠÙ†:', subsError.message);
    } else {
      console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ ${subscriptions.length} Ù…Ø´ØªØ±Ùƒ`);
      subscriptions.forEach((sub, index) => {
        const status = sub.active ? 'âœ… Ù†Ø´Ø·' : 'âŒ ØºÙŠØ± Ù†Ø´Ø·';
        console.log(`   ${index + 1}. ${sub.subscription_type} - ${status} - ÙŠÙ†ØªÙ‡ÙŠ: ${sub.expires_at}`);
      });
    }

    // ÙØ­Øµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
    console.log('\n4ï¸âƒ£ ÙØ­Øµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...');
    const { data: appSettings, error: settingsError } = await supabase
      .from('app_settings')
      .select('*');

    if (settingsError) {
      console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ÙØ­Øµ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚:', settingsError.message);
    } else if (appSettings && appSettings.length > 0) {
      console.log('âœ… Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…ÙˆØ¬ÙˆØ¯Ø©');
      appSettings.forEach(setting => {
        console.log(`   - ${setting.key}: ${setting.value}`);
      });
    } else {
      console.log('âŒ Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØªØ·Ø¨ÙŠÙ‚');
    }

  } catch (error) {
    console.error('âŒ Ø®Ø·Ø£ Ø¹Ø§Ù…:', error.message);
  }
}

// ØªØ´ØºÙŠÙ„ Ø§Ù„ÙØ­Øµ
if (require.main === module) {
  checkUserStatus();
}

module.exports = { checkUserStatus }; 